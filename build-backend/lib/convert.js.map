{"version":3,"file":"convert.js","sourceRoot":"","sources":["../../src/lib/convert.ts"],"names":[],"mappings":"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","sourcesContent":["// controller uses this file when build uploads\nexport function stringify(data: { data: ioBroker.ScriptObject | ioBroker.ChannelObject; id: string }): {\n    id: string;\n    data: string | undefined;\n} {\n    const obj = data.data;\n    let id = data.id;\n    let result: string | undefined;\n    if (data.data.type === 'channel') {\n        id = `${id.replace(/\\./g, '/').substring('script.js.'.length)}/_dir.json`;\n        result = JSON.stringify(obj, null, 2);\n    } else if (data.data.type === 'script') {\n        id = `${id.replace(/\\./g, '/').substring('script.js.'.length)}.json`;\n        if ((obj as ioBroker.ScriptObject).common?.source) {\n            const source = (obj as ioBroker.ScriptObject).common.source;\n            if ((obj as ioBroker.ScriptObject).common.enabled) {\n                // @ts-expect-error We do not use it\n                delete (obj as ioBroker.ScriptObject).common.enabled;\n            }\n            if ((obj as ioBroker.ScriptObject).common.engine === 'system.adapter.javascript.0') {\n                // @ts-expect-error We do not use it\n                delete (obj as ioBroker.ScriptObject).common.engine;\n            }\n            if ((obj as ioBroker.ScriptObject).common.engineType === 'Javascript/js') {\n                // @ts-expect-error We do not use it\n                delete (obj as ioBroker.ScriptObject).common.engineType;\n            }\n            // @ts-expect-error We do not use it\n            delete (obj as ioBroker.ScriptObject).common.name;\n            // @ts-expect-error We do not use it\n            delete (obj as ioBroker.ScriptObject).common.source;\n            if (JSON.stringify(obj.common) !== '{}') {\n                result = `/* -- do not edit following lines - START --\\n${JSON.stringify(obj.common, null, 2)}\\n-- do not edit previous lines - END --*/\\n${source}`;\n            } else {\n                result = source;\n            }\n        } else {\n            result = JSON.stringify(obj, null, 2);\n        }\n    }\n\n    return { id, data: result };\n}\n\nexport function parse(data: {\n    data: string;\n    id: string;\n}): { id: string; data: ioBroker.ScriptObject; error: string | undefined } | null {\n    let obj: string = data.data;\n    let id = data.id;\n    let error: string | undefined;\n    let name: string;\n    let result: ioBroker.Object | undefined;\n    if (id[id.length - 1] === '/') {\n        id = id.substring(0, id.length - 1);\n    }\n\n    if (!id.match(/\\.json$/)) {\n        return null;\n    }\n\n    if (id.match(/_dir\\.json$/)) {\n        name = id.substring(0, id.length - '/_dir.json'.length).replace(/\\//g, '.');\n\n        try {\n            result = JSON.parse(obj);\n        } catch (err: unknown) {\n            error = `Cannot parse object \"${name}\": ${err as Error}`;\n            result = {\n                common: {\n                    name: name.split('.').pop() || name,\n                },\n                type: 'channel',\n                _id: `script.js.${name}`,\n                native: {},\n            };\n        }\n        id = `script.js.${name}`;\n    } else {\n        //script\n        name = id.substring(0, id.length - '.json'.length).replace(/\\//g, '.');\n        let source: string;\n        if (obj.match(/^\\/\\*\\s--\\sdo\\snot/)) {\n            obj = obj.replace(/\\r\\n/g, '\\n').replace(/\\r/g, '\\n');\n            const lines = obj.split('\\n');\n            let stringObj = '';\n            let line = 1;\n            while (line < lines.length) {\n                if (lines[line].match(/^--\\sdo\\snot/)) {\n                    break;\n                }\n                stringObj += lines[line];\n                line++;\n            }\n            lines.splice(0, line + 1);\n            source = lines.join('\\n');\n            try {\n                result = {} as ioBroker.Object;\n                result.common = JSON.parse(stringObj);\n                result.common.source = source;\n            } catch (err: unknown) {\n                error = `Cannot parse object \"${id}\": ${err as Error}`;\n            }\n        } else {\n            source = obj;\n        }\n        result = {} as ioBroker.Object;\n        result.common = result.common || {};\n        result._id = `script.js.${name}`;\n        result.type = 'script';\n        result.common.name = name.split('.').pop() || name;\n        result.common.enabled = result.common.enabled === undefined ? true : result.common.enabled;\n        result.common.engine = result.common.engine || 'system.adapter.javascript.0';\n        result.common.engineType = result.common.engineType || 'Javascript/js';\n        result.common.source = result.common.source || source;\n        id = `script.js.${name}`;\n    }\n\n    return { id: id, data: result as ioBroker.ScriptObject, error: error };\n}\n"]}